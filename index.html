<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"BaBi | Presentes","short_name":"BaBi","display":"standalone","background_color":"#2a0813","theme_color":"#f472b6"}'>
    <meta name="theme-color" content="#f472b6">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>BaBi | Presentes</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* ========================================================
           TEMA PREMIUM: VINHO E ROSA
           ======================================================== */
        :root {
            --bg-base: #2a0813; --bg-panel: #3b0c1c; --bg-card: #4a1224; --bg-input: #1f050e;
            --border-light: rgba(244, 114, 182, 0.15); --border-hover: rgba(244, 114, 182, 0.3);
            --primary: #f472b6; --primary-hover: #fb7185; --primary-glow: rgba(244, 114, 182, 0.25);
            --text-main: #ffffff; --text-muted: #fbcfe8;
            --success: #34d399; --danger: #ef4444; --info: #60a5fa;
            --transition-smooth: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html, body { max-width: 100vw; overflow-x: hidden; }
        body { font-family: 'Inter', sans-serif; background-color: var(--bg-base); color: var(--text-main); background-image: linear-gradient(var(--border-light) 1px, transparent 1px), linear-gradient(90deg, var(--border-light) 1px, transparent 1px); background-size: 40px 40px; background-position: center top; min-height: 100vh; display: flex; }
        
        ::-webkit-scrollbar { width: 6px; } ::-webkit-scrollbar-track { background: var(--bg-base); } ::-webkit-scrollbar-thumb { background: #4a1224; border-radius: 4px; } ::-webkit-scrollbar-thumb:hover { background: var(--primary); }

        /* ========================================================
           LAYOUT E SIDEBAR
           ======================================================== */
        .dashboard { display: grid; grid-template-columns: 320px 1fr; width: 100%; min-height: 100vh; }
        .sidebar { background-color: var(--bg-panel); border-right: 1px solid var(--border-light); padding: 40px 25px; display: flex; flex-direction: column; gap: 30px; position: sticky; top: 0; height: 100vh; overflow-y: auto; box-shadow: 5px 0 30px rgba(0,0,0,0.5); z-index: 10; }
        
        .profile { text-align: center; }
        .avatar-wrapper { position: relative; width: 90px; height: 90px; margin: 0 auto 15px auto; }
        .avatar-gift { width: 100%; height: 100%; border-radius: 50%; border: 3px solid var(--primary); background: var(--bg-card); box-shadow: 0 0 25px var(--primary-glow); display: flex; justify-content: center; align-items: center; font-size: 2.5rem; color: var(--primary); }
        .level-badge { position: absolute; bottom: -5px; right: -5px; background: var(--primary); color: #2a0813; font-size: 0.75rem; font-weight: 800; padding: 4px 8px; border-radius: 12px; border: 2px solid var(--bg-panel); }
        .profile h2 { font-size: 1.4rem; font-weight: 700; margin-bottom: 5px; }
        .profile span { font-size: 0.85rem; color: var(--text-muted); }

        .form-section h3 { font-size: 1rem; margin-bottom: 12px; display: flex; align-items: center; gap: 8px; color: var(--text-main); font-weight: 600; }
        .form-section h3 i { color: var(--primary); }
        
        input { width: 100%; padding: 12px 15px; margin-bottom: 10px; background: var(--bg-input); border: 1px solid var(--border-light); color: var(--text-main); border-radius: 8px; font-family: 'Inter', sans-serif; font-size: 0.9rem; outline: none; transition: var(--transition-smooth); }
        input:focus { border-color: var(--primary); box-shadow: 0 0 0 1px var(--primary); background: #000; }
        input::placeholder { color: rgba(251, 207, 232, 0.3); }
        
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; } /* Duas colunas para Bruto e Lucro */

        button { width: 100%; padding: 12px; border-radius: 8px; font-weight: 800; font-size: 0.85rem; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; transition: var(--transition-smooth); border: none; display: flex; justify-content: center; align-items: center; gap: 8px; font-family: 'Inter', sans-serif;}
        .btn-theme { background: var(--primary); color: #2a0813; box-shadow: 0 4px 15px var(--primary-glow); }
        .btn-theme:hover { background: var(--primary-hover); transform: translateY(-2px); }
        .btn-outline { background: transparent; border: 1px dashed var(--primary); color: var(--primary); }
        .btn-outline:hover { background: var(--primary-glow); border-style: solid; color: #fff; transform: translateY(-2px); }
        .btn-dark { background: var(--bg-input); border: 1px solid var(--border-light); color: var(--text-main); }
        .btn-dark:hover { border-color: var(--primary); transform: translateY(-2px); }

        /* ========================================================
           ÁREA PRINCIPAL
           ======================================================== */
        .main-content { padding: 30px; display: flex; flex-direction: column; gap: 25px; max-width: 1500px; margin: 0 auto; width: 100%; }

        /* PAINEL DIÁRIO DUPLO */
        .today-panel { background: linear-gradient(145deg, var(--bg-panel), var(--bg-base)); border: 1px solid var(--primary); border-radius: 20px; padding: 25px; position: relative; box-shadow: 0 10px 30px var(--primary-glow); }
        .today-title { color: var(--text-muted); font-size: 1rem; text-transform: uppercase; letter-spacing: 1px; font-weight: 600; text-align: center; margin-bottom: 20px; }
        
        .today-metrics { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; text-align: center; }
        .metric-box { background: var(--bg-card); padding: 15px; border-radius: 12px; border: 1px solid var(--border-light); }
        .metric-box span { font-size: 0.8rem; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 5px; }
        .metric-box h2 { font-size: 2.2rem; margin: 0; }
        .val-bruto { color: var(--text-main); }
        .val-lucro { color: var(--success); text-shadow: 0 0 15px rgba(52, 211, 153, 0.3); }

        .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .stat-card { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 16px; padding: 20px; display: flex; align-items: center; gap: 15px; }
        .icon-box { min-width: 50px; height: 50px; border-radius: 12px; display: flex; justify-content: center; align-items: center; font-size: 1.4rem; }
        .icon-theme { background: rgba(244, 114, 182, 0.1); color: var(--primary); border: 1px solid rgba(244, 114, 182, 0.2); }
        .icon-green { background: rgba(52, 211, 153, 0.1); color: var(--success); border: 1px solid rgba(52, 211, 153, 0.2); }
        .icon-blue { background: rgba(96, 165, 250, 0.1); color: var(--info); border: 1px solid rgba(96, 165, 250, 0.2); }
        .stat-info span { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; display: block; margin-bottom: 3px; }
        .stat-info h3 { font-size: 1.5rem; margin: 0; }

        .panel { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 16px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); width: 100%; overflow: hidden; }
        .panel-header { margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .panel-header h3 { font-size: 1.1rem; display: flex; align-items: center; gap: 8px; margin: 0; }
        .chart-container { position: relative; height: 300px; width: 100%; }

        .bottom-grid { display: grid; grid-template-columns: 1.5fr 1fr; gap: 20px; align-items: start; width: 100%; }
        .widgets-column { display: flex; flex-direction: column; gap: 20px; width: 100%; }

        /* LISTAS E ITENS */
        .list { list-style: none; display: flex; flex-direction: column; gap: 10px; width: 100%; }
        .list-item { background: var(--bg-panel); border: 1px solid var(--border-light); border-radius: 12px; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; gap: 15px; transition: var(--transition-smooth); }
        .list-item:hover { border-color: var(--border-hover); background: #440d20; }
        
        .task-info { flex: 1; min-width: 0; }
        .task-info strong { display: block; font-size: 1.05rem; margin-bottom: 6px; word-break: break-word; }
        .task-meta { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; color: var(--text-muted); flex-wrap: wrap; }
        .badge { padding: 3px 8px; border-radius: 6px; font-weight: 700; font-size: 0.75rem; background: var(--bg-input); }
        .badge.bruto { border: 1px solid var(--border-light); color: var(--text-main); }
        .badge.lucro { border: 1px solid rgba(52, 211, 153, 0.3); color: var(--success); }

        .actions { display: flex; gap: 6px; flex-shrink: 0; }
        .btn-icon { width: 35px; height: 35px; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--border-light); color: var(--text-muted); display: flex; justify-content: center; align-items: center; cursor: pointer; transition: 0.2s; font-size: 1rem; }
        .btn-icon.check:hover { background: rgba(52, 211, 153, 0.2); color: var(--success); border-color: var(--success); }
        .btn-icon.edit:hover { background: rgba(96, 165, 250, 0.2); color: var(--info); border-color: var(--info); }
        .btn-icon.delete:hover { background: rgba(239, 68, 68, 0.2); color: var(--danger); border-color: var(--danger); }

        /* ========================================================
           MODAIS E ABAS MOBILE
           ======================================================== */
        .fab { display: none; position: fixed; bottom: 25px; right: 20px; width: 60px; height: 60px; background: var(--primary); color: #2a0813; border-radius: 30px; justify-content: center; align-items: center; font-size: 1.8rem; box-shadow: 0 0 15px var(--primary-glow), 0 0 30px rgba(244, 114, 182, 0.2); z-index: 100; border: none; }
        .fab:active { transform: scale(0.9); }

        .bottom-sheet { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-panel); border-radius: 24px 24px 0 0; padding: 25px; z-index: 1005; transform: translateY(100%); transition: 0.3s; border-top: 1px solid var(--border-light); visibility: hidden; }
        .bottom-sheet.active { transform: translateY(0); visibility: visible; display: block; }
        
        .tabs { display: flex; background: var(--bg-input); border-radius: 10px; padding: 5px; margin-bottom: 20px; }
        .tab-btn { flex: 1; text-align: center; padding: 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: var(--text-muted); cursor: pointer; transition: 0.2s; }
        .tab-btn.active { background: var(--primary); color: #2a0813; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; pointer-events: none; transition: 0.3s; padding: 20px; }
        .modal-overlay.active { opacity: 1; pointer-events: auto; }
        .modal-content { background: var(--bg-card); border: 1px solid var(--border-light); border-radius: 20px; padding: 25px; width: 100%; max-width: 400px; transform: scale(0.95); transition: 0.3s; }
        .modal-overlay.active .modal-content { transform: scale(1); }

        .toast-container { position: fixed; bottom: 30px; right: 30px; display: flex; flex-direction: column; gap: 10px; z-index: 9999; }
        .toast { background: var(--bg-panel); border-left: 4px solid var(--primary); color: #fff; padding: 15px; border-radius: 8px; display: flex; align-items: center; gap: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); font-size: 0.9rem; animation: slideIn 0.3s forwards, fadeOut 0.3s forwards 3s; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } }
        @keyframes fadeOut { to { opacity: 0; transform: translateY(10px); } }

        /* ========================================================
           RESPONSIVIDADE MOBILE
           ======================================================== */
        @media (max-width: 992px) {
            .dashboard { grid-template-columns: 1fr; display: flex; flex-direction: column; }
            .sidebar { height: auto; position: relative; border-right: none; border-bottom: 1px solid var(--border-light); padding: 25px 20px; }
            .sidebar-forms { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; }
        }
        @media (max-width: 768px) {
            body { padding-bottom: 90px; }
            .main-content { padding: 15px; gap: 15px; }
            .today-metrics { gap: 10px; }
            .metric-box h2 { font-size: 1.8rem; }
            .stats-grid { grid-template-columns: 1fr; gap: 10px; }
            .panel { padding: 15px; }
            .chart-container { height: 220px; }
            
            .sidebar-forms { display: none; } /* Esconde form no mobile para usar Bottom Sheet */
            .fab { display: flex; }
            
            /* Ajuste para botões na lista caberem no mobile */
            .list-item { flex-direction: column; align-items: flex-start; gap: 10px; }
            .actions { width: 100%; display: flex; justify-content: flex-end; border-top: 1px solid var(--border-light); padding-top: 10px; }
            .toast-container { right: 15px; left: 15px; bottom: 15px; }
            .toast { width: 100%; justify-content: center; }
        }
    </style>
</head>
<body>

    <div class="dashboard">
        <aside class="sidebar">
            <div class="profile">
                <div class="avatar-wrapper">
                    <div class="avatar-gift"><i class="fas fa-gift"></i></div>
                    <div class="level-badge" id="levelBadge">Lv. 1</div>
                </div>
                <h2>Olá, BaBi</h2>
                <span>Gestão de Pedidos</span>
            </div>

            <div class="sidebar-forms">
                <div class="form-section">
                    <h3><i class="fas fa-box-open"></i> Novo Pedido</h3>
                    <form onsubmit="handleAddTask(event, 'desktop')">
                        <input type="text" id="tNameD" placeholder="Ex: Cesta Casal..." required>
                        <div class="input-row">
                            <input type="number" id="tBrutoD" step="0.01" placeholder="Bruto (R$)" required title="Valor total cobrado do cliente">
                            <input type="number" id="tLucroD" step="0.01" placeholder="Lucro (R$)" required title="Lucro livre após os custos">
                        </div>
                        <button type="submit" class="btn-theme"><i class="fas fa-plus"></i> Adicionar à Fila</button>
                    </form>
                </div>
                <div class="form-section">
                    <h3><i class="fas fa-bullseye"></i> Definir Meta</h3>
                    <form onsubmit="handleAddGoal(event, 'desktop')">
                        <input type="text" id="gNameD" placeholder="Ex: Bater 5K em vendas" required>
                        <input type="number" id="gValD" step="0.01" placeholder="Valor Alvo (R$)" required>
                        <button type="submit" class="btn-outline"><i class="fas fa-flag"></i> Estabelecer Meta</button>
                    </form>
                </div>
                <div class="form-section">
                    <h3><i class="fas fa-calendar-alt"></i> Agendar Evento</h3>
                    <form onsubmit="handleAddEvent(event, 'desktop')">
                        <input type="text" id="eNameD" placeholder="Data comemorativa / Entrega" required>
                        <input type="date" id="eDateD" required>
                        <button type="submit" class="btn-dark"><i class="far fa-calendar-check"></i> Agendar</button>
                    </form>
                </div>
            </div>
        </aside>

        <main class="main-content">
            
            <div class="today-panel">
                <div class="today-title"><i class="fas fa-sun" style="color:var(--primary);"></i> Vendas de Hoje</div>
                <div class="today-metrics">
                    <div class="metric-box">
                        <span>Faturamento Bruto</span>
                        <h2 class="val-bruto" id="todayBruto">R$ 0</h2>
                    </div>
                    <div class="metric-box">
                        <span>Lucro Líquido</span>
                        <h2 class="val-lucro" id="todayLucro">R$ 0</h2>
                    </div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="icon-box icon-theme"><i class="fas fa-wallet"></i></div>
                    <div class="stat-info"><span>Bruto Mensal</span><h3 id="monthBruto">R$ 0,00</h3></div>
                </div>
                <div class="stat-card">
                    <div class="icon-box icon-green"><i class="fas fa-piggy-bank"></i></div>
                    <div class="stat-info"><span>Lucro Mensal</span><h3 id="monthLucro">R$ 0,00</h3></div>
                </div>
                <div class="stat-card">
                    <div class="icon-box icon-blue"><i class="fas fa-check-square"></i></div>
                    <div class="stat-info"><span>Pedidos Entregues</span><h3 id="monthCount">0</h3></div>
                </div>
            </div>

            <div class="panel">
                <div class="panel-header">
                    <h3><i class="fas fa-chart-area" style="color:var(--primary);"></i> Evolução de Faturamento x Lucro</h3>
                </div>
                <div class="chart-container"><canvas id="revenueChart"></canvas></div>
            </div>

            <div class="bottom-grid">
                <div class="panel">
                    <div class="panel-header"><h3><i class="fas fa-bolt" style="color: var(--primary);"></i> Fila de Pedidos</h3></div>
                    <div class="list" id="taskList"></div>
                    <button class="btn-dark" style="margin-top:15px; width:auto; padding:8px 15px;" onclick="toggleCompleted()"><i class="fas fa-eye"></i> Histórico Concluídos</button>
                    <div class="list" id="completedList" style="display:none; margin-top:15px; opacity:0.6;"></div>
                </div>

                <div class="widgets-column">
                    <div class="panel">
                        <div class="panel-header"><h3><i class="fas fa-flag"></i> Metas Ativas</h3></div>
                        <ul class="list" id="goalList"></ul>
                    </div>
                    <div class="panel">
                        <div class="panel-header"><h3><i class="far fa-calendar-check"></i> Próximos Eventos</h3></div>
                        <ul class="list" id="eventList"></ul>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <button class="fab" onclick="openBottomSheet()"><i class="fas fa-plus"></i></button>
    <div class="modal-overlay" id="overlay" onclick="closeBottomSheet()"></div>
    <div class="bottom-sheet" id="bottomSheet">
        <div class="tabs">
            <div class="tab-btn active" onclick="switchTab('tabPedido')">Pedido</div>
            <div class="tab-btn" onclick="switchTab('tabMeta')">Meta</div>
            <div class="tab-btn" onclick="switchTab('tabEvento')">Evento</div>
        </div>
        
        <div class="tab-content active" id="tabPedido">
            <form onsubmit="handleAddTask(event, 'mobile')">
                <input type="text" id="tNameM" placeholder="Nome da Cesta/Pedido" required>
                <div class="input-row">
                    <input type="number" id="tBrutoM" step="0.01" placeholder="Bruto (R$)" required>
                    <input type="number" id="tLucroM" step="0.01" placeholder="Lucro (R$)" required>
                </div>
                <button type="submit" class="btn-theme">Adicionar Pedido</button>
            </form>
        </div>
        <div class="tab-content" id="tabMeta">
            <form onsubmit="handleAddGoal(event, 'mobile')">
                <input type="text" id="gNameM" placeholder="Ex: Comprar material novo" required>
                <input type="number" id="gValM" step="0.01" placeholder="Valor Alvo (R$)" required>
                <button type="submit" class="btn-theme">Definir Meta</button>
            </form>
        </div>
        <div class="tab-content" id="tabEvento">
            <form onsubmit="handleAddEvent(event, 'mobile')">
                <input type="text" id="eNameM" placeholder="Nome do Evento/Data" required>
                <input type="date" id="eDateM" required>
                <button type="submit" class="btn-theme">Agendar Evento</button>
            </form>
        </div>
    </div>

    <div class="modal-overlay" id="editModalGeneric">
        <div class="modal-content" id="editModalContent">
            </div>
    </div>

    <div class="toast-container" id="toastBox"></div>

    <script>
        // Registra Service Worker para funcionar como App Offline
        if ("serviceWorker" in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register("sw.js").catch(err=>console.log(err)); }); }

        // Banco de Dados Local
        let appState = JSON.parse(localStorage.getItem('babi_presentes_v2')) || { tasks: [], goals: [], events: [] };
        
        // Correção de compatibilidade: garante que itens antigos tenham lucro
        appState.tasks.forEach(t => { if(t.profit === undefined) t.profit = t.value; });

        function saveData() { localStorage.setItem('babi_presentes_v2', JSON.stringify(appState)); renderAll(); }
        function isToday(dStr) { if(!dStr) return false; const d = new Date(dStr); const t = new Date(); return d.getDate() === t.getDate() && d.getMonth() === t.getMonth() && d.getFullYear() === t.getFullYear(); }

        function showToast(msg, type = 'success') {
            const box = document.getElementById('toastBox'); const t = document.createElement('div'); t.className = 'toast';
            t.innerHTML = `<i class="fas ${type==='error'?'fa-exclamation-circle':'fa-check-circle'}" style="color:var(--${type==='error'?'danger':'primary'});"></i> <span>${msg}</span>`;
            box.appendChild(t); setTimeout(() => t.remove(), 4000);
        }

        // ========================================================
        // GESTÃO DE ABAS E MODAIS (Mobile)
        // ========================================================
        function openBottomSheet() { document.getElementById('bottomSheet').classList.add('active'); document.getElementById('overlay').classList.add('active'); }
        function closeBottomSheet() { document.getElementById('bottomSheet').classList.remove('active'); document.getElementById('overlay').classList.remove('active'); }
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
        }

        function closeEditModal() { document.getElementById('editModalGeneric').classList.remove('active'); }

        // ========================================================
        // CRUD - PEDIDOS (TAREFAS)
        // ========================================================
        function handleAddTask(e, origin) {
            e.preventDefault();
            const name = document.getElementById(origin === 'desktop' ? 'tNameD' : 'tNameM').value;
            const value = parseFloat(document.getElementById(origin === 'desktop' ? 'tBrutoD' : 'tBrutoM').value);
            const profit = parseFloat(document.getElementById(origin === 'desktop' ? 'tLucroD' : 'tLucroM').value);
            
            appState.tasks.unshift({ id: Date.now(), name, value, profit, status: 'Pendente', createdAt: new Date().toISOString(), completedAt: null });
            e.target.reset(); if(origin==='mobile') closeBottomSheet();
            saveData(); showToast('Pedido na fila!');
        }

        function completeTask(id) {
            const task = appState.tasks.find(t => t.id === id);
            if(task) { task.status = 'Concluída'; task.completedAt = new Date().toISOString(); saveData(); showToast('Pedido Finalizado!', 'success'); }
        }
        function deleteTask(id) { appState.tasks = appState.tasks.filter(t => t.id !== id); saveData(); showToast('Pedido removido.', 'info'); }
        
        function openEditTask(id) {
            const t = appState.tasks.find(x => x.id === id);
            document.getElementById('editModalContent').innerHTML = `
                <h3 style="margin-bottom:20px;"><i class="fas fa-pen" style="color:var(--primary);"></i> Editar Pedido</h3>
                <form onsubmit="saveEditTask(event, ${id})">
                    <input type="text" id="edTName" value="${t.name}" required>
                    <div class="input-row">
                        <input type="number" id="edTVal" step="0.01" value="${t.value}" required>
                        <input type="number" id="edTProf" step="0.01" value="${t.profit}" required>
                    </div>
                    <div style="display:flex;gap:10px;margin-top:15px;"><button type="submit" class="btn-theme" style="flex:2;">Salvar</button><button type="button" class="btn-dark" style="flex:1;" onclick="closeEditModal()">Cancelar</button></div>
                </form>
            `;
            document.getElementById('editModalGeneric').classList.add('active');
        }
        function saveEditTask(e, id) {
            e.preventDefault(); const t = appState.tasks.find(x => x.id === id);
            t.name = document.getElementById('edTName').value; t.value = parseFloat(document.getElementById('edTVal').value); t.profit = parseFloat(document.getElementById('edTProf').value);
            closeEditModal(); saveData(); showToast('Pedido atualizado!');
        }

        function toggleCompleted() {
            const cl = document.getElementById('completedList');
            cl.style.display = cl.style.display === 'none' ? 'flex' : 'none';
        }

        // ========================================================
        // CRUD - METAS E EVENTOS
        // ========================================================
        function handleAddGoal(e, origin) {
            e.preventDefault();
            const name = document.getElementById(origin === 'desktop' ? 'gNameD' : 'gNameM').value;
            const value = parseFloat(document.getElementById(origin === 'desktop' ? 'gValD' : 'gValM').value);
            appState.goals.push({ id: Date.now(), name, value });
            e.target.reset(); if(origin==='mobile') closeBottomSheet(); saveData(); showToast('Meta estabelecida!');
        }
        function deleteGoal(id) { appState.goals = appState.goals.filter(g => g.id !== id); saveData(); }
        
        function openEditGoal(id) {
            const g = appState.goals.find(x => x.id === id);
            document.getElementById('editModalContent').innerHTML = `
                <h3 style="margin-bottom:20px;"><i class="fas fa-bullseye" style="color:var(--primary);"></i> Editar Meta</h3>
                <form onsubmit="saveEditGoal(event, ${id})">
                    <input type="text" id="edGName" value="${g.name}" required>
                    <input type="number" id="edGVal" step="0.01" value="${g.value}" required>
                    <div style="display:flex;gap:10px;margin-top:15px;"><button type="submit" class="btn-theme">Salvar</button><button type="button" class="btn-dark" onclick="closeEditModal()">Cancelar</button></div>
                </form>
            `;
            document.getElementById('editModalGeneric').classList.add('active');
        }
        function saveEditGoal(e, id) { e.preventDefault(); const g = appState.goals.find(x => x.id === id); g.name = document.getElementById('edGName').value; g.value = parseFloat(document.getElementById('edGVal').value); closeEditModal(); saveData(); }

        function handleAddEvent(e, origin) {
            e.preventDefault();
            const rawDate = document.getElementById(origin === 'desktop' ? 'eDateD' : 'eDateM').value;
            const name = document.getElementById(origin === 'desktop' ? 'eNameD' : 'eNameM').value;
            const [y, m, d] = rawDate.split('-');
            appState.events.push({ id: Date.now(), name, date: `${d}/${m}/${y}`, rawDate });
            appState.events.sort((a,b) => new Date(a.rawDate) - new Date(b.rawDate));
            e.target.reset(); if(origin==='mobile') closeBottomSheet(); saveData(); showToast('Agendado!');
        }
        function deleteEvent(id) { appState.events = appState.events.filter(ev => ev.id !== id); saveData(); }

        function openEditEvent(id) {
            const ev = appState.events.find(x => x.id === id);
            document.getElementById('editModalContent').innerHTML = `
                <h3 style="margin-bottom:20px;"><i class="far fa-calendar" style="color:var(--primary);"></i> Editar Evento</h3>
                <form onsubmit="saveEditEvent(event, ${id})">
                    <input type="text" id="edEName" value="${ev.name}" required>
                    <input type="date" id="edEDate" value="${ev.rawDate}" required>
                    <div style="display:flex;gap:10px;margin-top:15px;"><button type="submit" class="btn-theme">Salvar</button><button type="button" class="btn-dark" onclick="closeEditModal()">Cancelar</button></div>
                </form>
            `;
            document.getElementById('editModalGeneric').classList.add('active');
        }
        function saveEditEvent(e, id) { e.preventDefault(); const ev = appState.events.find(x => x.id === id); ev.name = document.getElementById('edEName').value; ev.rawDate = document.getElementById('edEDate').value; const [y,m,d] = ev.rawDate.split('-'); ev.date = `${d}/${m}/${y}`; appState.events.sort((a,b) => new Date(a.rawDate) - new Date(b.rawDate)); closeEditModal(); saveData(); }

        // ========================================================
        // RENDERIZAÇÃO
        // ========================================================
        function formatMoney(val) { return val.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }); }
        let revenueChartInstance = null;

        function renderAll() {
            const listTasks = document.getElementById('taskList'); const listCompleted = document.getElementById('completedList');
            const listGoals = document.getElementById('goalList'); const listEvents = document.getElementById('eventList');
            listTasks.innerHTML = ''; listCompleted.innerHTML = ''; listGoals.innerHTML = ''; listEvents.innerHTML = '';

            const currentMonthStr = `${new Date().getFullYear()}-${String(new Date().getMonth() + 1).padStart(2, '0')}`;
            let tBrutoHoje = 0, tLucroHoje = 0;
            let tBrutoMes = 0, tLucroMes = 0, countMes = 0;

            const pending = appState.tasks.filter(t => t.status === 'Pendente').sort((a, b) => b.value - a.value);
            const completed = appState.tasks.filter(t => t.status === 'Concluída');

            // Renderiza Pendentes
            pending.forEach(t => {
                const li = document.createElement('li'); li.className = 'list-item';
                li.innerHTML = `
                    <div class="task-info">
                        <strong>${t.name}</strong>
                        <div class="task-meta">
                            <span class="badge bruto">Bruto R$ ${formatMoney(t.value)}</span>
                            <span class="badge lucro">Lucro R$ ${formatMoney(t.profit)}</span>
                        </div>
                    </div>
                    <div class="actions">
                        <button class="btn-icon check" onclick="completeTask(${t.id})"><i class="fas fa-check"></i></button>
                        <button class="btn-icon edit" onclick="openEditTask(${t.id})"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon delete" onclick="deleteTask(${t.id})"><i class="fas fa-trash"></i></button>
                    </div>`;
                listTasks.appendChild(li);
            });

            // Processa e Renderiza Concluídas
            completed.forEach(t => {
                if(t.completedAt && t.completedAt.startsWith(currentMonthStr)) { tBrutoMes += t.value; tLucroMes += t.profit; countMes++; }
                if(isToday(t.completedAt)) { tBrutoHoje += t.value; tLucroHoje += t.profit; }
                const li = document.createElement('li'); li.className = 'list-item';
                li.innerHTML = `<div class="task-info"><strong style="text-decoration:line-through;color:var(--text-muted);">${t.name}</strong><div class="task-meta"><span class="badge bruto" style="opacity:0.5;">Bruto R$ ${formatMoney(t.value)}</span><span class="badge lucro" style="opacity:0.5;">Lucro R$ ${formatMoney(t.profit)}</span></div></div><div class="actions"><button class="btn-icon delete" onclick="deleteTask(${t.id})"><i class="fas fa-trash"></i></button></div>`;
                listCompleted.appendChild(li);
            });

            if(pending.length === 0) listTasks.innerHTML = `<p style="color:var(--text-muted); padding:10px;">Nenhum pedido pendente.</p>`;
            if(completed.length === 0) listCompleted.innerHTML = `<p style="color:var(--text-muted); padding:10px;">Nenhum histórico.</p>`;

            // Metas
            let totalGoalTarget = 0;
            appState.goals.forEach(g => {
                totalGoalTarget += g.value; const pct = Math.min((tBrutoMes / g.value) * 100, 100).toFixed(0);
                const li = document.createElement('li'); li.className = 'list-item goal-item';
                li.innerHTML = `
                    <div class="goal-header">
                        <div class="goal-header-text"><strong>${g.name}</strong><span style="color:var(--primary); font-size:0.85rem; font-weight:700;">R$ ${formatMoney(g.value)}</span></div>
                        <div class="actions">
                            <button class="btn-icon edit" onclick="openEditGoal(${g.id})"><i class="fas fa-pen"></i></button>
                            <button class="btn-icon delete" onclick="deleteGoal(${g.id})"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="goal-progress-bg"><div class="goal-progress-fill" style="width: ${isNaN(pct)?0:pct}%;"></div></div>`;
                listGoals.appendChild(li);
            });

            // Eventos
            appState.events.forEach(ev => {
                const li = document.createElement('li'); li.className = 'list-item';
                li.innerHTML = `
                    <div class="goal-header-text"><strong style="display:block; font-size:0.95rem; margin-bottom:5px;">${ev.name}</strong><span style="color:var(--text-muted); font-size:0.8rem;"><i class="far fa-clock"></i> ${ev.date}</span></div>
                    <div class="actions">
                        <button class="btn-icon edit" onclick="openEditEvent(${ev.id})"><i class="fas fa-pen"></i></button>
                        <button class="btn-icon delete" onclick="deleteEvent(${ev.id})"><i class="fas fa-times"></i></button>
                    </div>`;
                listEvents.appendChild(li);
            });

            // Atualiza Painéis
            document.getElementById('todayBruto').innerText = `R$ ${Math.floor(tBrutoHoje)}`;
            document.getElementById('todayLucro').innerText = `R$ ${Math.floor(tLucroHoje)}`;
            
            document.getElementById('monthBruto').innerText = `R$ ${formatMoney(tBrutoMes)}`;
            document.getElementById('monthLucro').innerText = `R$ ${formatMoney(tLucroMes)}`;
            document.getElementById('monthCount').innerText = countMes;

            const goalPct = totalGoalTarget > 0 ? Math.min(Math.floor((tBrutoMes / totalGoalTarget) * 100), 100) : 0;
            document.getElementById('displayGoalPct').innerText = `${goalPct}%`;

            const badge = document.getElementById('levelBadge');
            if (goalPct >= 100 && totalGoalTarget > 0) { badge.innerText = "Lv. MAX"; badge.style.background = "var(--success)"; badge.style.color = "#2a0813"; } 
            else if (goalPct >= 50) { badge.innerText = "Lv. 2"; badge.style.background = "var(--primary)"; } 
            else { badge.innerText = "Lv. 1"; badge.style.background = "var(--primary)"; }

            updateChart();
        }

        // Gráfico (2 Linhas)
        function updateChart() {
            const monthsNames = ['Jan', 'Fev', 'Mar', 'Abr', 'Mai', 'Jun', 'Jul', 'Ago', 'Set', 'Out', 'Nov', 'Dez'];
            const labels = []; const dataBruto = []; const dataLucro = []; const now = new Date();
            
            for (let i = 5; i >= 0; i--) {
                const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const mKey = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
                labels.push(`${monthsNames[d.getMonth()]} ${d.getFullYear()}`);
                
                let sBruto = 0, sLucro = 0;
                appState.tasks.forEach(t => { if(t.status === 'Concluída' && t.completedAt && t.completedAt.startsWith(mKey)) { sBruto += t.value; sLucro += t.profit; } });
                dataBruto.push(sBruto); dataLucro.push(sLucro);
            }

            const ctx = document.getElementById('revenueChart').getContext('2d');
            
            // Gradiente Bruto (Rosa)
            let gradRosa = ctx.createLinearGradient(0, 0, 0, 350);
            gradRosa.addColorStop(0, 'rgba(244, 114, 182, 0.4)'); gradRosa.addColorStop(1, 'rgba(244, 114, 182, 0.0)');
            // Gradiente Lucro (Verde)
            let gradVerde = ctx.createLinearGradient(0, 0, 0, 350);
            gradVerde.addColorStop(0, 'rgba(52, 211, 153, 0.4)'); gradVerde.addColorStop(1, 'rgba(52, 211, 153, 0.0)');

            if (revenueChartInstance) {
                revenueChartInstance.data.labels = labels; 
                revenueChartInstance.data.datasets[0].data = dataBruto; 
                revenueChartInstance.data.datasets[1].data = dataLucro; 
                revenueChartInstance.update();
            } else {
                revenueChartInstance = new Chart(ctx, {
                    type: 'line', 
                    data: { 
                        labels: labels, 
                        datasets: [
                            { label: 'Bruto (R$)', data: dataBruto, borderColor: '#f472b6', backgroundColor: gradRosa, borderWidth: 3, pointBackgroundColor: '#4a1224', pointBorderColor: '#f472b6', pointBorderWidth: 3, pointRadius: 5, fill: true, tension: 0.4 },
                            { label: 'Lucro (R$)', data: dataLucro, borderColor: '#34d399', backgroundColor: gradVerde, borderWidth: 3, pointBackgroundColor: '#4a1224', pointBorderColor: '#34d399', pointBorderWidth: 3, pointRadius: 5, fill: true, tension: 0.4 }
                        ] 
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        plugins: { legend: { position: 'top', labels: {color:'#fbcfe8', font:{family:'Inter'}} } }, 
                        scales: { y: { grid: { color: 'rgba(244,114,182,0.05)', drawBorder: false }, ticks: { color: '#fbcfe8', font: {family: 'Inter'} }, beginAtZero: true }, x: { grid: { display: false }, ticks: { color: '#fbcfe8', font: {family: 'Inter'} } } }, 
                        interaction: { intersect: false, mode: 'index' } 
                    }
                });
            }
        }

        renderAll();
    </script>
</body>
</html>
